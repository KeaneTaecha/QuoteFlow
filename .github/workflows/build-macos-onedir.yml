name: Build macOS Application (OneDir)

on:
  workflow_dispatch:


jobs:
  build-macos-onedir:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build macOS application (OneDir)
      run: |
        pyinstaller --onedir --windowed --name "QuoteFlow" --icon="assets/icon.icns" --add-data="src/ui:ui" --add-data="src/excel_to_sql:excel_to_sql" --add-data="src/utils:utils" --add-data="data/quotation_template.xlsx:data" --add-data="prices.db:." --add-data="assets:assets" --hidden-import="ui.quotation_ui" --hidden-import="utils.price_calculator" --hidden-import="utils.sql_loader" --hidden-import="utils.equation_parser" --hidden-import="utils.filter_utils" --hidden-import="utils.product_utils" --hidden-import="utils.quote_utils" --hidden-import="utils.excel_exporter" --hidden-import="utils.excel_importer" --hidden-import="excel_to_sql.getsql" --hidden-import="excel_to_sql.handlers.default_handler" --hidden-import="excel_to_sql.handlers.header_handler" --hidden-import="excel_to_sql.handlers.other_handler" --hidden-import="sqlite3" --hidden-import="openpyxl" src/main.py

    - name: Package .app bundle for upload
      run: |
        cd dist
        zip -r QuoteFlow-macOS-OneDir.zip QuoteFlow.app

    - name: Upload macOS application directory
      uses: actions/upload-artifact@v4
      with:
        name: QuoteFlow-macOS-OneDir
        path: dist/QuoteFlow-macOS-OneDir.zip
        retention-days: 30
