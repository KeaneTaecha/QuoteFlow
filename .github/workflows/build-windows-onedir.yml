name: Build Windows Executable (OneDir)

on:
  workflow_dispatch:

jobs:
  build-windows-onedir:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Generate ICO file
      run: |
        python -c "
        from PIL import Image, ImageDraw
        import os

        def add_rounded_corners(image, radius=200):
            mask = Image.new('L', image.size, 0)
            draw = ImageDraw.Draw(mask)
            draw.rounded_rectangle([0, 0, image.size[0], image.size[1]], radius=radius, fill=255)
            output = Image.new('RGBA', image.size, (0, 0, 0, 0))
            output.paste(image, mask=mask)
            return output

        img = Image.open('assets/icon.png').convert('RGBA')
        rounded_img = add_rounded_corners(img, radius=200)
        resized = rounded_img.resize((256, 256), Image.LANCZOS)
        resized.save('assets/icon.ico', format='ICO')
        print('Generated ICO file:', os.path.getsize('assets/icon.ico'), 'bytes')
        "

    - name: Build Windows executable (OneDir)
      run: |
        pyinstaller --onedir --windowed --name "QuoteFlow" --icon="assets/icon.ico" --add-data="src/ui;ui" --add-data="src/database;database" --add-data="src/excel_exporter.py;." --add-data="data/quotation_template.xlsx;data" --add-data="prices.db;." --add-data="assets;assets" --hidden-import="ui.quotation_ui" --hidden-import="database.price_loader" --hidden-import="database.getsql" --hidden-import="database.handlers.default_handler" --hidden-import="database.handlers.header_handler" --hidden-import="database.handlers.other_handler" --hidden-import="excel_exporter" --hidden-import="sqlite3" --hidden-import="openpyxl" src/main.py

    - name: Upload Windows executable directory
      uses: actions/upload-artifact@v4
      with:
        name: QuoteFlow-Windows-OneDir
        path: dist/QuoteFlow/
        retention-days: 30
